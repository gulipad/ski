<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skier Pose Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", monospace;
        background: #1a1a1a;
        color: white;
        overflow: hidden;
      }

      #canvas-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      #controls-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 350px;
        max-height: 90vh;
        background: rgba(0, 0, 0, 0.9);
        border-radius: 8px;
        padding: 15px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      #animations-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 320px;
        max-height: 90vh;
        background: rgba(0, 0, 0, 0.9);
        border-radius: 8px;
        padding: 15px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }

      #animations-panel h2 {
        color: #f1c40f;
        margin-bottom: 15px;
        font-size: 1.2rem;
      }

      .animation-section {
        margin-bottom: 25px;
        padding: 15px;
        background: rgba(52, 152, 219, 0.1);
        border: 1px solid #3498db;
        border-radius: 4px;
      }

      .animation-section h3 {
        color: #3498db;
        margin-bottom: 10px;
        font-size: 1rem;
        font-weight: bold;
      }

      #controls-panel h2 {
        color: #f1c40f;
        margin-bottom: 15px;
        font-size: 1.2rem;
      }

      .control-group {
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .control-group label {
        width: 70px;
        font-size: 0.85rem;
      }

      .control-group input[type="range"] {
        width: 150px;
      }

      .control-group span {
        width: 50px;
        text-align: right;
        font-size: 0.8rem;
        color: #87ceeb;
      }

      .bone-section {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #444;
      }

      .bone-title {
        font-size: 0.9rem;
        color: #f1c40f;
        margin-bottom: 8px;
        font-weight: bold;
      }

      button {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: bold;
        transition: background 0.2s;
      }

      button:hover {
        background: #229954;
      }

      button.secondary {
        background: #3498db;
      }

      button.secondary:hover {
        background: #2980b9;
      }

      #pose-output {
        margin-top: 20px;
        padding: 15px;
        background: rgba(52, 152, 219, 0.1);
        border-radius: 4px;
        border: 1px solid #3498db;
      }

      #pose-output h3 {
        color: #3498db;
        margin-bottom: 10px;
        font-size: 1rem;
      }

      #pose-code {
        font-family: "Courier New", monospace;
        font-size: 0.75rem;
        line-height: 1.6;
        color: #87ceeb;
        white-space: pre-wrap;
        word-break: break-all;
        user-select: all;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
      }

      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.2rem;
        color: #87ceeb;
      }

      .info-text {
        font-size: 0.8rem;
        color: #95a5a6;
        margin-top: 10px;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div id="loading">Loading skier model...</div>
    <div id="canvas-container"></div>

    <!-- Animations Panel (Left Side) -->
    <div id="animations-panel">
      <h2>Animations</h2>

      <!-- Base Animation Section -->
      <div class="animation-section">
        <h3>Base Animation</h3>
        <div style="margin-bottom: 15px">
          <label style="display: flex; align-items: center; cursor: pointer">
            <input
              type="checkbox"
              id="enable-base-anim"
              style="margin-right: 8px; width: auto"
            />
            <span>Enable</span>
          </label>
        </div>
        <div id="base-anim-params">
          <div class="control-group" style="margin-bottom: 10px">
            <label>Speed</label>
            <input
              type="range"
              id="base-anim-speed"
              min="0.5"
              max="3"
              step="0.1"
              value="1.9"
            />
            <span id="val-base-anim-speed">1.9</span>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="bone-title" style="margin-bottom: 8px">
              Pelvis Rot Y
            </div>
            <div class="control-group">
              <label>Amplitude</label>
              <input
                type="range"
                id="pelvis-y-amp"
                min="0"
                max="0.3"
                step="0.01"
                value="0.19"
              />
              <span id="val-pelvis-y-amp">0.19</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="bone-title" style="margin-bottom: 8px">Waist Rot Y</div>
            <div class="control-group">
              <label>Amplitude</label>
              <input
                type="range"
                id="waist-y-amp"
                min="0"
                max="0.3"
                step="0.01"
                value="0.20"
              />
              <span id="val-waist-y-amp">0.20</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="bone-title" style="margin-bottom: 8px">Head Rot Y</div>
            <div class="control-group">
              <label>Amplitude</label>
              <input
                type="range"
                id="head-y-amp"
                min="0"
                max="0.3"
                step="0.01"
                value="0.19"
              />
              <span id="val-head-y-amp">0.19</span>
            </div>
          </div>
          <button
            id="copy-base-params"
            class="secondary"
            style="
              margin-top: 15px;
              padding: 8px;
              font-size: 0.85rem;
              width: 100%;
            "
          >
            Copy Parameters
          </button>
        </div>
      </div>

      <!-- Jump Animation Section -->
      <div class="animation-section">
        <h3>Jump Animation</h3>
        <div id="jump-anim-params">
          <div class="control-group" style="margin-bottom: 10px">
            <label>Speed</label>
            <input
              type="range"
              id="jump-anim-speed"
              min="0.5"
              max="3"
              step="0.1"
              value="1.0"
            />
            <span id="val-jump-anim-speed">1.0</span>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>L_Upperarm Z</label>
              <input
                type="range"
                id="jump-l-arm-z"
                min="-0.5"
                max="0.5"
                step="0.01"
                value="-0.12"
              />
              <span id="val-jump-l-arm-z">-0.12</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>R_Upperarm Z</label>
              <input
                type="range"
                id="jump-r-arm-z"
                min="-0.5"
                max="0.5"
                step="0.01"
                value="0.02"
              />
              <span id="val-jump-r-arm-z">0.02</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>L_Thigh Y</label>
              <input
                type="range"
                id="jump-l-thigh-y"
                min="-1"
                max="1"
                step="0.01"
                value="-0.42"
              />
              <span id="val-jump-l-thigh-y">-0.42</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>R_Thigh Y</label>
              <input
                type="range"
                id="jump-r-thigh-y"
                min="-1"
                max="1"
                step="0.01"
                value="0.63"
              />
              <span id="val-jump-r-thigh-y">0.63</span>
            </div>
          </div>
          <button
            id="test-jump"
            class="secondary"
            style="
              margin-top: 10px;
              padding: 8px;
              font-size: 0.85rem;
              width: 100%;
            "
          >
            Test Jump Animation
          </button>
          <button
            id="copy-jump-params"
            class="secondary"
            style="
              margin-top: 10px;
              padding: 8px;
              font-size: 0.85rem;
              width: 100%;
            "
          >
            Copy Parameters
          </button>
        </div>
      </div>

      <!-- Right Turn Animation Section -->
      <div class="animation-section">
        <h3>Right Turn Animation</h3>
        <div id="right-turn-params">
          <div class="control-group" style="margin-bottom: 10px">
            <label>Speed</label>
            <input
              type="range"
              id="right-turn-speed"
              min="0.5"
              max="3"
              step="0.1"
              value="1.0"
            />
            <span id="val-right-turn-speed">1.0</span>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>Pelvis Rot Y</label>
              <input
                type="range"
                id="right-turn-pelvis-y"
                min="-2"
                max="2"
                step="0.01"
                value="-1.02"
              />
              <span id="val-right-turn-pelvis-y">-1.02</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>Head Rot Y</label>
              <input
                type="range"
                id="right-turn-head-y"
                min="-2"
                max="2"
                step="0.01"
                value="0.13"
              />
              <span id="val-right-turn-head-y">0.13</span>
            </div>
          </div>
          <button
            id="test-right-turn"
            class="secondary"
            style="
              margin-top: 10px;
              padding: 8px;
              font-size: 0.85rem;
              width: 100%;
            "
          >
            Test Right Turn
          </button>
          <button
            id="copy-right-turn-params"
            class="secondary"
            style="
              margin-top: 10px;
              padding: 8px;
              font-size: 0.85rem;
              width: 100%;
            "
          >
            Copy Parameters
          </button>
        </div>
      </div>

      <!-- Left Turn Animation Section -->
      <div class="animation-section">
        <h3>Left Turn Animation</h3>
        <div id="left-turn-params">
          <div class="control-group" style="margin-bottom: 10px">
            <label>Speed</label>
            <input
              type="range"
              id="left-turn-speed"
              min="0.5"
              max="3"
              step="0.1"
              value="1.0"
            />
            <span id="val-left-turn-speed">1.0</span>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>Pelvis Rot Y</label>
              <input
                type="range"
                id="left-turn-pelvis-y"
                min="-2"
                max="2"
                step="0.01"
                value="-0.02"
              />
              <span id="val-left-turn-pelvis-y">-0.02</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>Head Rot Y</label>
              <input
                type="range"
                id="left-turn-head-y"
                min="-2"
                max="2"
                step="0.01"
                value="-0.87"
              />
              <span id="val-left-turn-head-y">-0.87</span>
            </div>
          </div>
          <button
            id="test-left-turn"
            class="secondary"
            style="
              margin-top: 10px;
              padding: 8px;
              font-size: 0.85rem;
              width: 100%;
            "
          >
            Test Left Turn
          </button>
          <button
            id="copy-left-turn-params"
            class="secondary"
            style="
              margin-top: 10px;
              padding: 8px;
              font-size: 0.85rem;
              width: 100%;
            "
          >
            Copy Parameters
          </button>
        </div>
      </div>

      <!-- Crash Animation Section -->
      <div class="animation-section">
        <h3>Crash Animation</h3>
        <div id="crash-anim-params">
          <div class="control-group" style="margin-bottom: 10px">
            <label>Speed</label>
            <input
              type="range"
              id="crash-anim-speed"
              min="0.5"
              max="3"
              step="0.1"
              value="1.25"
            />
            <span id="val-crash-anim-speed">1.25</span>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>Pelvis Z</label>
              <input
                type="range"
                id="crash-pelvis-z"
                min="-3.14"
                max="3.14"
                step="0.01"
                value="-3.14"
              />
              <span id="val-crash-pelvis-z">-3.14</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>Hip X</label>
              <input
                type="range"
                id="crash-hip-x"
                min="-2"
                max="2"
                step="0.01"
                value="1.53"
              />
              <span id="val-crash-hip-x">1.53</span>
            </div>
            <div class="control-group">
              <label>Hip Y</label>
              <input
                type="range"
                id="crash-hip-y"
                min="-2"
                max="2"
                step="0.01"
                value="-0.97"
              />
              <span id="val-crash-hip-y">-0.97</span>
            </div>
            <div class="control-group">
              <label>Hip Z</label>
              <input
                type="range"
                id="crash-hip-z"
                min="-2"
                max="2"
                step="0.01"
                value="0.83"
              />
              <span id="val-crash-hip-z">0.83</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>L_Thigh Y</label>
              <input
                type="range"
                id="crash-l-thigh-y"
                min="-2"
                max="2"
                step="0.01"
                value="0.28"
              />
              <span id="val-crash-l-thigh-y">0.28</span>
            </div>
            <div class="control-group">
              <label>L_Thigh Z</label>
              <input
                type="range"
                id="crash-l-thigh-z"
                min="-2"
                max="2"
                step="0.01"
                value="1.33"
              />
              <span id="val-crash-l-thigh-z">1.33</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>R_Thigh Y</label>
              <input
                type="range"
                id="crash-r-thigh-y"
                min="-2"
                max="2"
                step="0.01"
                value="-0.27"
              />
              <span id="val-crash-r-thigh-y">-0.27</span>
            </div>
            <div class="control-group">
              <label>R_Thigh Z</label>
              <input
                type="range"
                id="crash-r-thigh-z"
                min="-2"
                max="2"
                step="0.01"
                value="1.33"
              />
              <span id="val-crash-r-thigh-z">1.33</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>Head Z</label>
              <input
                type="range"
                id="crash-head-z"
                min="-2"
                max="2"
                step="0.01"
                value="0.88"
              />
              <span id="val-crash-head-z">0.88</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>R_Hand Y</label>
              <input
                type="range"
                id="crash-r-hand-y"
                min="-2"
                max="2"
                step="0.01"
                value="-1.57"
              />
              <span id="val-crash-r-hand-y">-1.57</span>
            </div>
          </div>
          <div
            style="
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px solid #444;
            "
          >
            <div class="control-group">
              <label>L_Hand Y</label>
              <input
                type="range"
                id="crash-l-hand-y"
                min="-2"
                max="2"
                step="0.01"
                value="1.53"
              />
              <span id="val-crash-l-hand-y">1.53</span>
            </div>
          </div>
          <button
            id="test-crash"
            class="secondary"
            style="
              margin-top: 10px;
              padding: 8px;
              font-size: 0.85rem;
              width: 100%;
            "
          >
            Test Crash Animation
          </button>
          <button
            id="copy-crash-params"
            class="secondary"
            style="
              margin-top: 10px;
              padding: 8px;
              font-size: 0.85rem;
              width: 100%;
            "
          >
            Copy Parameters
          </button>
        </div>
      </div>
    </div>

    <!-- Controls Panel (Right Side) -->
    <div id="controls-panel">
      <h2>Skier Pose Editor</h2>

      <button id="apply-skiing-pose">Apply Skiing Pose</button>
      <button id="reset-pose" class="secondary">Reset to Default</button>
      <button id="copy-pose" class="secondary">Copy Pose Code</button>
      <button id="copy-camera" class="secondary">Copy Camera Position</button>

      <div class="info-text" style="margin-top: 15px">
        Use mouse to rotate/zoom the camera. Adjust bones below to pose the
        skier.
      </div>

      <div id="bone-controls"></div>

      <div id="pose-output" style="display: none">
        <h3>Pose Values:</h3>
        <div id="pose-code"></div>
      </div>
    </div>

    <script>
      // Scene setup
      let scene, camera, renderer, controls;
      let skierModel;
      let skierBones = {};
      let boneParams = {};
      let skierBaseOffset = { x: 0, y: 0, z: 0 };

      // Animation state
      let baseAnimationEnabled = false;
      let baseAnimationSpeed = 1.9;
      let animationTime = 0;
      let animationParams = {
        pelvis: { baseY: 0, amplitude: 0.19 },
        waist: { baseY: 0, amplitude: 0.2 },
        head: { baseY: -0.47, amplitude: 0.19 },
      };

      // Jump animation state
      let jumpAnimationSpeed = 1.0;
      let jumpAnimationParams = {
        lUpperarmZ: -0.12,
        rUpperarmZ: 0.02,
        lThighY: -0.42,
        rThighY: 0.63,
      };
      let isJumping = false;
      let jumpAnimationTime = 0;

      // Turn animation state
      let rightTurnSpeed = 1.0;
      let rightTurnParams = {
        pelvisY: -1.02,
        headY: 0.13,
      };
      let rightTurnBaseValues = { pelvisY: 0, headY: 0 };
      let isRightTurning = false;
      let rightTurnTime = 0;

      let leftTurnSpeed = 1.0;
      let leftTurnParams = {
        pelvisY: -0.02,
        headY: -0.87,
      };
      let leftTurnBaseValues = { pelvisY: 0, headY: 0 };
      let isLeftTurning = false;
      let leftTurnTime = 0;

      // Crash animation state
      let crashAnimationSpeed = 1.25;
      let crashAnimationParams = {
        pelvisZ: -3.14,
        hipX: 1.53,
        hipY: -0.97,
        hipZ: 0.83,
        lThighY: 0.28,
        lThighZ: 1.33,
        rThighY: -0.27,
        rThighZ: 1.33,
        headZ: 0.88,
        rHandY: -1.57,
        lHandY: 1.53,
      };
      let crashBaseValues = {
        pelvisZ: 0,
        hipX: 0,
        hipY: 0,
        hipZ: 0,
        lThighY: 0,
        lThighZ: 0,
        rThighY: 0,
        rThighZ: 0,
        headZ: 0,
        rHandY: 0,
        lHandY: 0,
      };
      let isCrashing = false;
      let crashTime = 0;

      // Initialize scene
      function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x2c3e50);

        camera = new THREE.PerspectiveCamera(
          50,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(-0.92, 4.77, -6.75);
        camera.lookAt(-0.07, 1.06, -0.05);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document
          .getElementById("canvas-container")
          .appendChild(renderer.domElement);

        // Orbit controls for camera
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 5;
        controls.maxDistance = 50;
        controls.target.set(-0.07, 1.06, -0.05);
        controls.update();

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);

        const fillLight = new THREE.DirectionalLight(0x87ceeb, 0.4);
        fillLight.position.set(-10, 10, -10);
        scene.add(fillLight);

        // Grid helper
        const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
        scene.add(gridHelper);

        // Load skier model
        loadSkierModel();

        // Handle window resize
        window.addEventListener("resize", onWindowResize);

        // Setup buttons
        document
          .getElementById("apply-skiing-pose")
          .addEventListener("click", applySkiingPose);
        document
          .getElementById("reset-pose")
          .addEventListener("click", resetPose);
        document
          .getElementById("copy-pose")
          .addEventListener("click", copyPoseCode);
        document
          .getElementById("copy-camera")
          .addEventListener("click", copyCameraPosition);

        // Setup animation controls
        setupAnimationControls();

        animate();
      }

      function loadSkierModel() {
        const loader = new THREE.GLTFLoader();
        loader.load(
          "/assets/models/skier_v1.glb",
          (gltf) => {
            skierModel = gltf.scene;

            // Center the model
            const box = new THREE.Box3().setFromObject(skierModel);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());

            skierBaseOffset.x = -center.x;
            skierBaseOffset.y = -box.min.y;
            skierBaseOffset.z = -center.z;

            skierModel.position.set(
              skierBaseOffset.x,
              skierBaseOffset.y,
              skierBaseOffset.z
            );

            // Scale
            skierModel.scale.set(3.9, 3.9, 3.9);

            // Enable shadows and brighten materials
            skierModel.traverse((child) => {
              if (child.isMesh) {
                child.castShadow = true;
                child.receiveShadow = true;

                if (child.material) {
                  if (child.material.metalness !== undefined) {
                    child.material.metalness = Math.min(
                      child.material.metalness,
                      0.1
                    );
                    child.material.roughness = Math.max(
                      child.material.roughness,
                      0.8
                    );
                  }

                  if (child.material.color) {
                    child.material.color.multiplyScalar(1.5);
                  }

                  if (child.material.emissive) {
                    child.material.emissive.setRGB(0.1, 0.1, 0.1);
                    child.material.emissiveIntensity = 0.3;
                  }

                  child.material.needsUpdate = true;
                }
              }

              // Store bones
              if (child.isBone || child.type === "Bone") {
                skierBones[child.name] = child;
              }
            });

            // Check for skeleton
            if (gltf.scene.children[0] && gltf.scene.children[0].skeleton) {
              const skeleton = gltf.scene.children[0].skeleton;
              skeleton.bones.forEach((bone) => {
                skierBones[bone.name] = bone;
              });
            }

            scene.add(skierModel);

            // Initialize bone rotations
            const boneNames = Object.keys(skierBones);
            console.log("Total bones found:", boneNames.length);
            console.log("Bone names:", boneNames);

            if (boneNames.length > 0) {
              boneNames.forEach((boneName) => {
                const bone = skierBones[boneName];
                if (bone) {
                  const euler = new THREE.Euler().setFromQuaternion(
                    bone.quaternion
                  );
                  boneParams[boneName] = {
                    x: euler.x,
                    y: euler.y,
                    z: euler.z,
                  };
                }
              });
              setupBoneControls(boneNames);

              // Apply skiing pose automatically on load
              applySkiingPose();

              document.getElementById("loading").style.display = "none";
            }
          },
          (progress) => {
            const percent = ((progress.loaded / progress.total) * 100).toFixed(
              1
            );
            document.getElementById(
              "loading"
            ).textContent = `Loading skier model... ${percent}%`;
          },
          (error) => {
            console.error("Error loading model:", error);
            document.getElementById("loading").textContent =
              "Error loading model!";
          }
        );
      }

      function setupBoneControls(boneNames) {
        const boneControlsDiv = document.getElementById("bone-controls");

        // Filter for main bones (skip twist bones)
        const relevantBones = boneNames.filter((name) => {
          const lower = name.toLowerCase();
          return (
            (lower.includes("arm") && !lower.includes("twist")) ||
            (lower.includes("hand") && !lower.includes("twist")) ||
            (lower.includes("thigh") && !lower.includes("twist")) ||
            (lower.includes("calf") && !lower.includes("twist")) ||
            (lower.includes("foot") && !lower.includes("twist")) ||
            lower.includes("head") ||
            lower.includes("neck") ||
            lower.includes("clavicle") ||
            lower.includes("spine") ||
            lower.includes("waist") ||
            lower.includes("pelvis") ||
            lower.includes("hip")
          );
        });

        const bonesToShow =
          relevantBones.length > 0
            ? relevantBones
            : boneNames
                .filter((n) => !n.toLowerCase().includes("twist"))
                .slice(0, 15);

        bonesToShow.forEach((boneName) => {
          if (!boneParams[boneName]) {
            boneParams[boneName] = { x: 0, y: 0, z: 0 };
          }

          const boneSection = document.createElement("div");
          boneSection.className = "bone-section";

          const boneTitle = document.createElement("div");
          boneTitle.className = "bone-title";
          boneTitle.textContent = boneName;
          boneSection.appendChild(boneTitle);

          ["X", "Y", "Z"].forEach((axis) => {
            const controlGroup = document.createElement("div");
            controlGroup.className = "control-group";

            const label = document.createElement("label");
            label.textContent = `Rot ${axis}`;
            controlGroup.appendChild(label);

            const input = document.createElement("input");
            input.type = "range";
            input.id = `bone_${boneName}_${axis}`;
            // Increase range for Pelvis Z rotation
            if (boneName === "Pelvis" && axis === "Z") {
              input.min = "-3.14";
              input.max = "3.14";
            } else {
              input.min = "-1.57";
              input.max = "1.57";
            }
            input.step = "0.05";
            input.value = boneParams[boneName][axis.toLowerCase()];
            controlGroup.appendChild(input);

            const span = document.createElement("span");
            span.id = `val_bone_${boneName}_${axis}`;
            span.textContent =
              boneParams[boneName][axis.toLowerCase()].toFixed(2);
            controlGroup.appendChild(span);

            boneSection.appendChild(controlGroup);

            input.addEventListener("input", (e) => {
              const val = parseFloat(e.target.value);
              boneParams[boneName][axis.toLowerCase()] = val;
              updateBoneRotation(boneName);
              span.textContent = val.toFixed(2);
              updatePoseOutput();
            });
          });

          boneControlsDiv.appendChild(boneSection);
        });

        updatePoseOutput();
      }

      function updateBoneRotation(boneName) {
        if (skierBones[boneName] && boneParams[boneName]) {
          const bone = skierBones[boneName];
          const params = boneParams[boneName];

          const euler = new THREE.Euler(params.x, params.y, params.z, "XYZ");
          bone.quaternion.setFromEuler(euler);

          if (
            skierModel &&
            skierModel.children[0] &&
            skierModel.children[0].skeleton
          ) {
            skierModel.children[0].skeleton.update();
          }
        }
      }

      function applySkiingPose() {
        const skiingPose = {
          Root: { x: -1.57, y: 0.0, z: 1.57 },
          Hip: { x: 0.73, y: -0.83, z: -0.14 },
          Pelvis: { x: -2.2, y: -0.65, z: -2.44 },
          L_Thigh: { x: -3.06, y: 0.01, z: 0.6 },
          L_Calf: { x: 0.01, y: -0.01, z: -0.96 },
          L_Foot: { x: 1.02, y: 0.42, z: 1.5 },
          L_CalfTwist01: { x: -0.0, y: 0.0, z: -0.0 },
          L_CalfTwist02: { x: -0.0, y: 0.0, z: 0.0 },
          L_ThighTwist01: { x: 0.0, y: 0.0, z: -0.0 },
          L_ThighTwist02: { x: 0.0, y: -0.0, z: 0.0 },
          R_Thigh: { x: -2.88, y: 0.03, z: 0.6 },
          R_ThighTwist01: { x: 0.0, y: -0.0, z: -0.0 },
          R_ThighTwist02: { x: -0.0, y: -0.0, z: 0.0 },
          R_Calf: { x: -0.22, y: 0.11, z: -0.8 },
          R_Foot: { x: 1.12, y: 0.31, z: 1.4 },
          R_CalfTwist01: { x: 0.0, y: -0.0, z: 0.0 },
          R_CalfTwist02: { x: -0.0, y: -0.0, z: 0.0 },
          Waist: { x: -2.2, y: -0.65, z: -2.44 },
          Spine01: { x: -0.0, y: -0.0, z: -0.0 },
          Spine02: { x: 0.0, y: 0.0, z: 0.0 },
          NeckTwist01: { x: 0.0, y: -0.0, z: -0.0 },
          NeckTwist02: { x: 0.0, y: 0.0, z: 0.0 },
          Head: { x: -0.0, y: -0.47, z: -0.0 },
          L_Clavicle: { x: -2.37, y: -1.39, z: 2.39 },
          L_Upperarm: { x: 0.36, y: -0.0, z: -1.03 },
          L_Forearm: { x: 1.22, y: 0.99, z: -0.27 },
          L_ForearmTwist01: { x: -0.0, y: -0.0, z: -0.0 },
          L_ForearmTwist02: { x: 0.0, y: -0.0, z: 0.0 },
          L_Hand: { x: -0.0, y: -0.0, z: 0.0 },
          L_UpperarmTwist01: { x: 0.0, y: 0.0, z: -0.0 },
          L_UpperarmTwist02: { x: 0.0, y: 0.0, z: 0.0 },
          R_Clavicle: { x: -2.24, y: -1.41, z: -0.84 },
          R_Upperarm: { x: -0.32, y: 0.13, z: 0.88 },
          R_UpperarmTwist01: { x: -0.0, y: -0.0, z: -0.0 },
          R_UpperarmTwist02: { x: -0.0, y: -0.0, z: 0.0 },
          R_Forearm: { x: 1.38, y: -0.02, z: 0.48 },
          R_ForearmTwist01: { x: 0.0, y: -0.0, z: 0.0 },
          R_ForearmTwist02: { x: -0.0, y: 0.0, z: -0.0 },
          R_Hand: { x: 0.03, y: 0.38, z: 0.08 },
        };

        Object.keys(skiingPose).forEach((boneName) => {
          if (skierBones[boneName] && skiingPose[boneName]) {
            const pose = skiingPose[boneName];
            boneParams[boneName] = {
              x: pose.x || 0,
              y: pose.y || 0,
              z: pose.z || 0,
            };

            // Store base values for animated bones
            if (boneName === "Pelvis") {
              animationParams.pelvis.baseY = boneParams[boneName].y;
            } else if (boneName === "Waist") {
              animationParams.waist.baseY = boneParams[boneName].y;
            } else if (boneName === "Head") {
              animationParams.head.baseY = boneParams[boneName].y;
            } else if (boneName === "L_Upperarm") {
              lUpperarmBaseZ = boneParams[boneName].z;
            } else if (boneName === "R_Upperarm") {
              rUpperarmBaseZ = boneParams[boneName].z;
            } else if (boneName === "L_Thigh") {
              lThighBaseY = boneParams[boneName].y;
            } else if (boneName === "R_Thigh") {
              rThighBaseY = boneParams[boneName].y;
            }

            updateBoneRotation(boneName);

            ["X", "Y", "Z"].forEach((axis) => {
              const input = document.getElementById(`bone_${boneName}_${axis}`);
              const span = document.getElementById(
                `val_bone_${boneName}_${axis}`
              );
              if (input && span) {
                const val = boneParams[boneName][axis.toLowerCase()];
                input.value = val;
                span.textContent = val.toFixed(2);
              }
            });
          }
        });

        updatePoseOutput();
      }

      function resetPose() {
        Object.keys(boneParams).forEach((boneName) => {
          boneParams[boneName] = { x: 0, y: 0, z: 0 };
          updateBoneRotation(boneName);

          ["X", "Y", "Z"].forEach((axis) => {
            const input = document.getElementById(`bone_${boneName}_${axis}`);
            const span = document.getElementById(
              `val_bone_${boneName}_${axis}`
            );
            if (input && span) {
              input.value = 0;
              span.textContent = "0.00";
            }
          });
        });

        updatePoseOutput();
      }

      function updatePoseOutput() {
        const outputDiv = document.getElementById("pose-output");
        const codeDiv = document.getElementById("pose-code");

        // Only show bones that have non-zero rotations
        const activeBones = Object.keys(boneParams).filter((boneName) => {
          const params = boneParams[boneName];
          return params.x !== 0 || params.y !== 0 || params.z !== 0;
        });

        if (activeBones.length === 0) {
          outputDiv.style.display = "none";
          return;
        }

        outputDiv.style.display = "block";

        let code = "const skiingPose = {\n";
        activeBones.forEach((boneName, index) => {
          const params = boneParams[boneName];
          code += `  ${boneName}: { x: ${params.x.toFixed(
            2
          )}, y: ${params.y.toFixed(2)}, z: ${params.z.toFixed(2)} }`;
          if (index < activeBones.length - 1) code += ",";
          code += "\n";
        });
        code += "};";

        codeDiv.textContent = code;
      }

      function copyPoseCode() {
        const codeDiv = document.getElementById("pose-code");
        const text = codeDiv.textContent;
        navigator.clipboard.writeText(text).then(() => {
          const btn = document.getElementById("copy-pose");
          const originalText = btn.textContent;
          btn.textContent = "Copied!";
          btn.style.background = "#27ae60";
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = "#3498db";
          }, 2000);
        });
      }

      function copyCameraPosition() {
        const pos = camera.position;
        const target = controls.target;
        const code = `camera.position.set(${pos.x.toFixed(2)}, ${pos.y.toFixed(
          2
        )}, ${pos.z.toFixed(2)});
camera.lookAt(${target.x.toFixed(2)}, ${target.y.toFixed(
          2
        )}, ${target.z.toFixed(2)});
// Or using OrbitControls target:
controls.target.set(${target.x.toFixed(2)}, ${target.y.toFixed(
          2
        )}, ${target.z.toFixed(2)});
controls.update();`;

        navigator.clipboard.writeText(code).then(() => {
          const btn = document.getElementById("copy-camera");
          const originalText = btn.textContent;
          btn.textContent = "Copied!";
          btn.style.background = "#27ae60";
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = "#3498db";
          }, 2000);
        });
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function setupAnimationControls() {
        // Base Animation Controls
        const baseEnableCheckbox = document.getElementById("enable-base-anim");
        const baseSpeedInput = document.getElementById("base-anim-speed");
        const baseSpeedVal = document.getElementById("val-base-anim-speed");
        const pelvisAmpInput = document.getElementById("pelvis-y-amp");
        const pelvisAmpVal = document.getElementById("val-pelvis-y-amp");
        const waistAmpInput = document.getElementById("waist-y-amp");
        const waistAmpVal = document.getElementById("val-waist-y-amp");
        const headAmpInput = document.getElementById("head-y-amp");
        const headAmpVal = document.getElementById("val-head-y-amp");
        const copyBaseParamsBtn = document.getElementById("copy-base-params");

        baseEnableCheckbox.addEventListener("change", (e) => {
          baseAnimationEnabled = e.target.checked;
          if (baseAnimationEnabled) {
            // Store base values when enabling
            if (boneParams.Pelvis)
              animationParams.pelvis.baseY = boneParams.Pelvis.y;
            if (boneParams.Waist)
              animationParams.waist.baseY = boneParams.Waist.y;
            if (boneParams.Head) animationParams.head.baseY = boneParams.Head.y;
          } else {
            // Reset to base values when disabling
            if (boneParams.Pelvis) {
              boneParams.Pelvis.y = animationParams.pelvis.baseY;
              updateBoneRotation("Pelvis");
              updateBoneSlider("Pelvis", "Y");
            }
            if (boneParams.Waist) {
              boneParams.Waist.y = animationParams.waist.baseY;
              updateBoneRotation("Waist");
              updateBoneSlider("Waist", "Y");
            }
            if (boneParams.Head) {
              boneParams.Head.y = animationParams.head.baseY;
              updateBoneRotation("Head");
              updateBoneSlider("Head", "Y");
            }
          }
        });

        baseSpeedInput.addEventListener("input", (e) => {
          baseAnimationSpeed = parseFloat(e.target.value);
          baseSpeedVal.textContent = baseAnimationSpeed.toFixed(1);
        });

        pelvisAmpInput.addEventListener("input", (e) => {
          animationParams.pelvis.amplitude = parseFloat(e.target.value);
          pelvisAmpVal.textContent =
            animationParams.pelvis.amplitude.toFixed(2);
        });

        waistAmpInput.addEventListener("input", (e) => {
          animationParams.waist.amplitude = parseFloat(e.target.value);
          waistAmpVal.textContent = animationParams.waist.amplitude.toFixed(2);
        });

        headAmpInput.addEventListener("input", (e) => {
          animationParams.head.amplitude = parseFloat(e.target.value);
          headAmpVal.textContent = animationParams.head.amplitude.toFixed(2);
        });

        copyBaseParamsBtn.addEventListener("click", () => {
          const params = {
            speed: baseAnimationSpeed,
            pelvisAmplitude: animationParams.pelvis.amplitude,
            waistAmplitude: animationParams.waist.amplitude,
            headAmplitude: animationParams.head.amplitude,
          };
          const code = `const baseAnimationParams = {
  speed: ${params.speed.toFixed(1)},
  pelvisAmplitude: ${params.pelvisAmplitude.toFixed(2)},
  waistAmplitude: ${params.waistAmplitude.toFixed(2)},
  headAmplitude: ${params.headAmplitude.toFixed(2)},
};`;
          navigator.clipboard.writeText(code).then(() => {
            copyBaseParamsBtn.textContent = "Copied!";
            setTimeout(() => {
              copyBaseParamsBtn.textContent = "Copy Parameters";
            }, 2000);
          });
        });

        // Jump Animation Controls
        const jumpSpeedInput = document.getElementById("jump-anim-speed");
        const jumpSpeedVal = document.getElementById("val-jump-anim-speed");
        const jumpLArmInput = document.getElementById("jump-l-arm-z");
        const jumpLArmVal = document.getElementById("val-jump-l-arm-z");
        const jumpRArmInput = document.getElementById("jump-r-arm-z");
        const jumpRArmVal = document.getElementById("val-jump-r-arm-z");
        const jumpLThighInput = document.getElementById("jump-l-thigh-y");
        const jumpLThighVal = document.getElementById("val-jump-l-thigh-y");
        const jumpRThighInput = document.getElementById("jump-r-thigh-y");
        const jumpRThighVal = document.getElementById("val-jump-r-thigh-y");
        const testJumpBtn = document.getElementById("test-jump");
        const copyJumpParamsBtn = document.getElementById("copy-jump-params");

        jumpSpeedInput.addEventListener("input", (e) => {
          jumpAnimationSpeed = parseFloat(e.target.value);
          jumpSpeedVal.textContent = jumpAnimationSpeed.toFixed(1);
        });

        jumpLArmInput.addEventListener("input", (e) => {
          jumpAnimationParams.lUpperarmZ = parseFloat(e.target.value);
          jumpLArmVal.textContent = jumpAnimationParams.lUpperarmZ.toFixed(2);
        });

        jumpRArmInput.addEventListener("input", (e) => {
          jumpAnimationParams.rUpperarmZ = parseFloat(e.target.value);
          jumpRArmVal.textContent = jumpAnimationParams.rUpperarmZ.toFixed(2);
        });

        jumpLThighInput.addEventListener("input", (e) => {
          jumpAnimationParams.lThighY = parseFloat(e.target.value);
          jumpLThighVal.textContent = jumpAnimationParams.lThighY.toFixed(2);
        });

        jumpRThighInput.addEventListener("input", (e) => {
          jumpAnimationParams.rThighY = parseFloat(e.target.value);
          jumpRThighVal.textContent = jumpAnimationParams.rThighY.toFixed(2);
        });

        testJumpBtn.addEventListener("click", () => {
          if (isJumping) {
            resetJumpAnimation();
          } else {
            startJumpAnimation();
          }
        });

        copyJumpParamsBtn.addEventListener("click", () => {
          const params = {
            speed: jumpAnimationSpeed,
            lUpperarmZ: jumpAnimationParams.lUpperarmZ,
            rUpperarmZ: jumpAnimationParams.rUpperarmZ,
            lThighY: jumpAnimationParams.lThighY,
            rThighY: jumpAnimationParams.rThighY,
          };
          const code = `const jumpAnimationParams = {
  speed: ${params.speed.toFixed(1)},
  lUpperarmZ: ${params.lUpperarmZ.toFixed(2)},
  rUpperarmZ: ${params.rUpperarmZ.toFixed(2)},
  lThighY: ${params.lThighY.toFixed(2)},
  rThighY: ${params.rThighY.toFixed(2)},
};`;
          navigator.clipboard.writeText(code).then(() => {
            copyJumpParamsBtn.textContent = "Copied!";
            setTimeout(() => {
              copyJumpParamsBtn.textContent = "Copy Parameters";
            }, 2000);
          });
        });

        // Right Turn Animation Controls
        const rightTurnSpeedInput = document.getElementById("right-turn-speed");
        const rightTurnSpeedVal = document.getElementById(
          "val-right-turn-speed"
        );
        const rightTurnPelvisInput = document.getElementById(
          "right-turn-pelvis-y"
        );
        const rightTurnPelvisVal = document.getElementById(
          "val-right-turn-pelvis-y"
        );
        const rightTurnHeadInput = document.getElementById("right-turn-head-y");
        const rightTurnHeadVal = document.getElementById(
          "val-right-turn-head-y"
        );
        const testRightTurnBtn = document.getElementById("test-right-turn");
        const copyRightTurnParamsBtn = document.getElementById(
          "copy-right-turn-params"
        );

        rightTurnSpeedInput.addEventListener("input", (e) => {
          rightTurnSpeed = parseFloat(e.target.value);
          rightTurnSpeedVal.textContent = rightTurnSpeed.toFixed(1);
        });

        rightTurnPelvisInput.addEventListener("input", (e) => {
          rightTurnParams.pelvisY = parseFloat(e.target.value);
          rightTurnPelvisVal.textContent = rightTurnParams.pelvisY.toFixed(2);
        });

        rightTurnHeadInput.addEventListener("input", (e) => {
          rightTurnParams.headY = parseFloat(e.target.value);
          rightTurnHeadVal.textContent = rightTurnParams.headY.toFixed(2);
        });

        testRightTurnBtn.addEventListener("click", () => {
          if (isRightTurning) {
            resetRightTurn();
          } else {
            startRightTurn();
          }
        });

        copyRightTurnParamsBtn.addEventListener("click", () => {
          const params = {
            speed: rightTurnSpeed,
            pelvisY: rightTurnParams.pelvisY,
            headY: rightTurnParams.headY,
          };
          const code = `const rightTurnParams = {
  speed: ${params.speed.toFixed(1)},
  pelvisY: ${params.pelvisY.toFixed(2)},
  headY: ${params.headY.toFixed(2)},
};`;
          navigator.clipboard.writeText(code).then(() => {
            copyRightTurnParamsBtn.textContent = "Copied!";
            setTimeout(() => {
              copyRightTurnParamsBtn.textContent = "Copy Parameters";
            }, 2000);
          });
        });

        // Left Turn Animation Controls
        const leftTurnSpeedInput = document.getElementById("left-turn-speed");
        const leftTurnSpeedVal = document.getElementById("val-left-turn-speed");
        const leftTurnPelvisInput =
          document.getElementById("left-turn-pelvis-y");
        const leftTurnPelvisVal = document.getElementById(
          "val-left-turn-pelvis-y"
        );
        const leftTurnHeadInput = document.getElementById("left-turn-head-y");
        const leftTurnHeadVal = document.getElementById("val-left-turn-head-y");
        const testLeftTurnBtn = document.getElementById("test-left-turn");
        const copyLeftTurnParamsBtn = document.getElementById(
          "copy-left-turn-params"
        );

        leftTurnSpeedInput.addEventListener("input", (e) => {
          leftTurnSpeed = parseFloat(e.target.value);
          leftTurnSpeedVal.textContent = leftTurnSpeed.toFixed(1);
        });

        leftTurnPelvisInput.addEventListener("input", (e) => {
          leftTurnParams.pelvisY = parseFloat(e.target.value);
          leftTurnPelvisVal.textContent = leftTurnParams.pelvisY.toFixed(2);
        });

        leftTurnHeadInput.addEventListener("input", (e) => {
          leftTurnParams.headY = parseFloat(e.target.value);
          leftTurnHeadVal.textContent = leftTurnParams.headY.toFixed(2);
        });

        testLeftTurnBtn.addEventListener("click", () => {
          if (isLeftTurning) {
            resetLeftTurn();
          } else {
            startLeftTurn();
          }
        });

        copyLeftTurnParamsBtn.addEventListener("click", () => {
          const params = {
            speed: leftTurnSpeed,
            pelvisY: leftTurnParams.pelvisY,
            headY: leftTurnParams.headY,
          };
          const code = `const leftTurnParams = {
  speed: ${params.speed.toFixed(1)},
  pelvisY: ${params.pelvisY.toFixed(2)},
  headY: ${params.headY.toFixed(2)},
};`;
          navigator.clipboard.writeText(code).then(() => {
            copyLeftTurnParamsBtn.textContent = "Copied!";
            setTimeout(() => {
              copyLeftTurnParamsBtn.textContent = "Copy Parameters";
            }, 2000);
          });
        });

        // Crash Animation Controls
        const crashSpeedInput = document.getElementById("crash-anim-speed");
        const crashSpeedVal = document.getElementById("val-crash-anim-speed");
        const crashPelvisZInput = document.getElementById("crash-pelvis-z");
        const crashPelvisZVal = document.getElementById("val-crash-pelvis-z");
        const crashHipXInput = document.getElementById("crash-hip-x");
        const crashHipXVal = document.getElementById("val-crash-hip-x");
        const crashHipYInput = document.getElementById("crash-hip-y");
        const crashHipYVal = document.getElementById("val-crash-hip-y");
        const crashHipZInput = document.getElementById("crash-hip-z");
        const crashHipZVal = document.getElementById("val-crash-hip-z");
        const crashLThighInput = document.getElementById("crash-l-thigh-y");
        const crashLThighVal = document.getElementById("val-crash-l-thigh-y");
        const crashLThighZInput = document.getElementById("crash-l-thigh-z");
        const crashLThighZVal = document.getElementById("val-crash-l-thigh-z");
        const crashRThighInput = document.getElementById("crash-r-thigh-y");
        const crashRThighVal = document.getElementById("val-crash-r-thigh-y");
        const crashRThighZInput = document.getElementById("crash-r-thigh-z");
        const crashRThighZVal = document.getElementById("val-crash-r-thigh-z");
        const crashHeadInput = document.getElementById("crash-head-z");
        const crashHeadVal = document.getElementById("val-crash-head-z");
        const crashRHandInput = document.getElementById("crash-r-hand-y");
        const crashRHandVal = document.getElementById("val-crash-r-hand-y");
        const crashLHandInput = document.getElementById("crash-l-hand-y");
        const crashLHandVal = document.getElementById("val-crash-l-hand-y");
        const testCrashBtn = document.getElementById("test-crash");
        const copyCrashParamsBtn = document.getElementById("copy-crash-params");

        crashSpeedInput.addEventListener("input", (e) => {
          crashAnimationSpeed = parseFloat(e.target.value);
          crashSpeedVal.textContent = crashAnimationSpeed.toFixed(1);
        });

        crashPelvisZInput.addEventListener("input", (e) => {
          crashAnimationParams.pelvisZ = parseFloat(e.target.value);
          crashPelvisZVal.textContent = crashAnimationParams.pelvisZ.toFixed(2);
        });

        crashHipXInput.addEventListener("input", (e) => {
          crashAnimationParams.hipX = parseFloat(e.target.value);
          crashHipXVal.textContent = crashAnimationParams.hipX.toFixed(2);
        });

        crashHipYInput.addEventListener("input", (e) => {
          crashAnimationParams.hipY = parseFloat(e.target.value);
          crashHipYVal.textContent = crashAnimationParams.hipY.toFixed(2);
        });

        crashHipZInput.addEventListener("input", (e) => {
          crashAnimationParams.hipZ = parseFloat(e.target.value);
          crashHipZVal.textContent = crashAnimationParams.hipZ.toFixed(2);
        });

        crashLThighInput.addEventListener("input", (e) => {
          crashAnimationParams.lThighY = parseFloat(e.target.value);
          crashLThighVal.textContent = crashAnimationParams.lThighY.toFixed(2);
        });

        crashLThighZInput.addEventListener("input", (e) => {
          crashAnimationParams.lThighZ = parseFloat(e.target.value);
          crashLThighZVal.textContent = crashAnimationParams.lThighZ.toFixed(2);
        });

        crashRThighInput.addEventListener("input", (e) => {
          crashAnimationParams.rThighY = parseFloat(e.target.value);
          crashRThighVal.textContent = crashAnimationParams.rThighY.toFixed(2);
        });

        crashRThighZInput.addEventListener("input", (e) => {
          crashAnimationParams.rThighZ = parseFloat(e.target.value);
          crashRThighZVal.textContent = crashAnimationParams.rThighZ.toFixed(2);
        });

        crashHeadInput.addEventListener("input", (e) => {
          crashAnimationParams.headZ = parseFloat(e.target.value);
          crashHeadVal.textContent = crashAnimationParams.headZ.toFixed(2);
        });

        crashRHandInput.addEventListener("input", (e) => {
          crashAnimationParams.rHandY = parseFloat(e.target.value);
          crashRHandVal.textContent = crashAnimationParams.rHandY.toFixed(2);
        });

        crashLHandInput.addEventListener("input", (e) => {
          crashAnimationParams.lHandY = parseFloat(e.target.value);
          crashLHandVal.textContent = crashAnimationParams.lHandY.toFixed(2);
        });

        testCrashBtn.addEventListener("click", () => {
          if (isCrashing) {
            resetCrashAnimation();
          } else {
            startCrashAnimation();
          }
        });

        copyCrashParamsBtn.addEventListener("click", () => {
          const params = {
            speed: crashAnimationSpeed,
            pelvisZ: crashAnimationParams.pelvisZ,
            hipX: crashAnimationParams.hipX,
            hipY: crashAnimationParams.hipY,
            hipZ: crashAnimationParams.hipZ,
            lThighY: crashAnimationParams.lThighY,
            lThighZ: crashAnimationParams.lThighZ,
            rThighY: crashAnimationParams.rThighY,
            rThighZ: crashAnimationParams.rThighZ,
            headZ: crashAnimationParams.headZ,
            rHandY: crashAnimationParams.rHandY,
            lHandY: crashAnimationParams.lHandY,
          };
          const code = `const crashAnimationParams = {
  speed: ${params.speed.toFixed(1)},
  pelvisZ: ${params.pelvisZ.toFixed(2)},
  hipX: ${params.hipX.toFixed(2)},
  hipY: ${params.hipY.toFixed(2)},
  hipZ: ${params.hipZ.toFixed(2)},
  lThighY: ${params.lThighY.toFixed(2)},
  lThighZ: ${params.lThighZ.toFixed(2)},
  rThighY: ${params.rThighY.toFixed(2)},
  rThighZ: ${params.rThighZ.toFixed(2)},
  headZ: ${params.headZ.toFixed(2)},
  rHandY: ${params.rHandY.toFixed(2)},
  lHandY: ${params.lHandY.toFixed(2)},
};`;
          navigator.clipboard.writeText(code).then(() => {
            copyCrashParamsBtn.textContent = "Copied!";
            setTimeout(() => {
              copyCrashParamsBtn.textContent = "Copy Parameters";
            }, 2000);
          });
        });
      }

      function updateBoneSlider(boneName, axis) {
        const input = document.getElementById(`bone_${boneName}_${axis}`);
        const span = document.getElementById(`val_bone_${boneName}_${axis}`);
        if (input && span && boneParams[boneName]) {
          const val = boneParams[boneName][axis.toLowerCase()];
          input.value = val;
          span.textContent = val.toFixed(2);
        }
      }

      function updateAnimations(deltaTime) {
        if (!baseAnimationEnabled) return;

        animationTime += deltaTime * baseAnimationSpeed;

        // Pelvis - slower, smoother sway
        if (boneParams.Pelvis && skierBones.Pelvis) {
          const offset =
            Math.sin(animationTime * 0.8) * animationParams.pelvis.amplitude;
          boneParams.Pelvis.y = animationParams.pelvis.baseY + offset;
          updateBoneRotation("Pelvis");
          updateBoneSlider("Pelvis", "Y");
        }

        // Waist - slightly faster, counter to pelvis
        if (boneParams.Waist && skierBones.Waist) {
          const offset =
            Math.sin(animationTime * 1.2 + Math.PI * 0.3) *
            animationParams.waist.amplitude;
          boneParams.Waist.y = animationParams.waist.baseY + offset;
          updateBoneRotation("Waist");
          updateBoneSlider("Waist", "Y");
        }

        // Head - faster, subtle movement
        if (boneParams.Head && skierBones.Head) {
          const offset =
            Math.sin(animationTime * 1.5 + Math.PI * 0.5) *
            animationParams.head.amplitude;
          boneParams.Head.y = animationParams.head.baseY + offset;
          updateBoneRotation("Head");
          updateBoneSlider("Head", "Y");
        }
      }

      let lUpperarmBaseZ = 0;
      let rUpperarmBaseZ = 0;
      let lThighBaseY = 0;
      let rThighBaseY = 0;

      function startJumpAnimation() {
        if (!boneParams.L_Upperarm || !boneParams.R_Upperarm) return;

        // Store base values (current position)
        lUpperarmBaseZ = boneParams.L_Upperarm.z;
        rUpperarmBaseZ = boneParams.R_Upperarm.z;
        if (boneParams.L_Thigh) lThighBaseY = boneParams.L_Thigh.y;
        if (boneParams.R_Thigh) rThighBaseY = boneParams.R_Thigh.y;

        isJumping = true;
        jumpAnimationTime = 0;
        document.getElementById("test-jump").textContent = "Animating...";
      }

      function resetJumpAnimation() {
        if (!boneParams.L_Upperarm || !boneParams.R_Upperarm) return;

        // Reset to base values
        boneParams.L_Upperarm.z = lUpperarmBaseZ;
        boneParams.R_Upperarm.z = rUpperarmBaseZ;
        if (boneParams.L_Thigh) boneParams.L_Thigh.y = lThighBaseY;
        if (boneParams.R_Thigh) boneParams.R_Thigh.y = rThighBaseY;

        updateBoneRotation("L_Upperarm");
        updateBoneRotation("R_Upperarm");
        if (boneParams.L_Thigh) updateBoneRotation("L_Thigh");
        if (boneParams.R_Thigh) updateBoneRotation("R_Thigh");

        updateBoneSlider("L_Upperarm", "Z");
        updateBoneSlider("R_Upperarm", "Z");
        if (boneParams.L_Thigh) updateBoneSlider("L_Thigh", "Y");
        if (boneParams.R_Thigh) updateBoneSlider("R_Thigh", "Y");

        isJumping = false;
        jumpAnimationTime = 0;
        document.getElementById("test-jump").textContent =
          "Test Jump Animation";
      }

      function updateJumpAnimation(deltaTime) {
        if (!isJumping) return;

        jumpAnimationTime += deltaTime * jumpAnimationSpeed;
        const jumpUpDuration = 0.3; // Time to go from base to jump position
        const jumpDownDuration = 0.3; // Time to go from jump back to base
        const totalDuration = jumpUpDuration + jumpDownDuration;

        let progress = 0;

        if (jumpAnimationTime < jumpUpDuration) {
          // Phase 1: Going up (base  jump position)
          const t = jumpAnimationTime / jumpUpDuration;
          // Ease out for going up
          progress = 1 - (1 - t) * (1 - t);
        } else if (jumpAnimationTime < totalDuration) {
          // Phase 2: Going down (jump position  base)
          const t = (jumpAnimationTime - jumpUpDuration) / jumpDownDuration;
          // Ease in for going down
          progress = 1 - t * t;
        } else {
          // Animation complete - reset to base
          resetJumpAnimation();
          return;
        }

        if (boneParams.L_Upperarm && skierBones.L_Upperarm) {
          boneParams.L_Upperarm.z =
            lUpperarmBaseZ +
            (jumpAnimationParams.lUpperarmZ - lUpperarmBaseZ) * progress;
          updateBoneRotation("L_Upperarm");
          updateBoneSlider("L_Upperarm", "Z");
        }

        if (boneParams.R_Upperarm && skierBones.R_Upperarm) {
          boneParams.R_Upperarm.z =
            rUpperarmBaseZ +
            (jumpAnimationParams.rUpperarmZ - rUpperarmBaseZ) * progress;
          updateBoneRotation("R_Upperarm");
          updateBoneSlider("R_Upperarm", "Z");
        }

        if (boneParams.L_Thigh && skierBones.L_Thigh) {
          boneParams.L_Thigh.y =
            lThighBaseY +
            (jumpAnimationParams.lThighY - lThighBaseY) * progress;
          updateBoneRotation("L_Thigh");
          updateBoneSlider("L_Thigh", "Y");
        }

        if (boneParams.R_Thigh && skierBones.R_Thigh) {
          boneParams.R_Thigh.y =
            rThighBaseY +
            (jumpAnimationParams.rThighY - rThighBaseY) * progress;
          updateBoneRotation("R_Thigh");
          updateBoneSlider("R_Thigh", "Y");
        }
      }

      function startRightTurn() {
        if (!boneParams.Pelvis || !boneParams.Head) return;
        rightTurnBaseValues.pelvisY = boneParams.Pelvis.y;
        rightTurnBaseValues.headY = boneParams.Head.y;
        isRightTurning = true;
        rightTurnTime = 0;
        document.getElementById("test-right-turn").textContent = "Animating...";
      }

      function resetRightTurn() {
        if (!boneParams.Pelvis || !boneParams.Head) return;
        boneParams.Pelvis.y = rightTurnBaseValues.pelvisY;
        boneParams.Head.y = rightTurnBaseValues.headY;
        updateBoneRotation("Pelvis");
        updateBoneRotation("Head");
        updateBoneSlider("Pelvis", "Y");
        updateBoneSlider("Head", "Y");
        isRightTurning = false;
        rightTurnTime = 0;
        document.getElementById("test-right-turn").textContent =
          "Test Right Turn";
      }

      function updateRightTurnAnimation(deltaTime) {
        if (!isRightTurning) return;

        rightTurnTime += deltaTime * rightTurnSpeed;
        const turnUpDuration = 0.2;
        const turnDownDuration = 0.2;
        const totalDuration = turnUpDuration + turnDownDuration;

        let progress = 0;
        if (rightTurnTime < turnUpDuration) {
          const t = rightTurnTime / turnUpDuration;
          progress = 1 - (1 - t) * (1 - t);
        } else if (rightTurnTime < totalDuration) {
          const t = (rightTurnTime - turnUpDuration) / turnDownDuration;
          progress = 1 - t * t;
        } else {
          resetRightTurn();
          return;
        }

        if (boneParams.Pelvis && skierBones.Pelvis) {
          boneParams.Pelvis.y =
            rightTurnBaseValues.pelvisY +
            (rightTurnParams.pelvisY - rightTurnBaseValues.pelvisY) * progress;
          updateBoneRotation("Pelvis");
          updateBoneSlider("Pelvis", "Y");
        }

        if (boneParams.Head && skierBones.Head) {
          boneParams.Head.y =
            rightTurnBaseValues.headY +
            (rightTurnParams.headY - rightTurnBaseValues.headY) * progress;
          updateBoneRotation("Head");
          updateBoneSlider("Head", "Y");
        }
      }

      function startLeftTurn() {
        if (!boneParams.Pelvis || !boneParams.Head) return;
        leftTurnBaseValues.pelvisY = boneParams.Pelvis.y;
        leftTurnBaseValues.headY = boneParams.Head.y;
        isLeftTurning = true;
        leftTurnTime = 0;
        document.getElementById("test-left-turn").textContent = "Animating...";
      }

      function resetLeftTurn() {
        if (!boneParams.Pelvis || !boneParams.Head) return;
        boneParams.Pelvis.y = leftTurnBaseValues.pelvisY;
        boneParams.Head.y = leftTurnBaseValues.headY;
        updateBoneRotation("Pelvis");
        updateBoneRotation("Head");
        updateBoneSlider("Pelvis", "Y");
        updateBoneSlider("Head", "Y");
        isLeftTurning = false;
        leftTurnTime = 0;
        document.getElementById("test-left-turn").textContent =
          "Test Left Turn";
      }

      function updateLeftTurnAnimation(deltaTime) {
        if (!isLeftTurning) return;

        leftTurnTime += deltaTime * leftTurnSpeed;
        const turnUpDuration = 0.2;
        const turnDownDuration = 0.2;
        const totalDuration = turnUpDuration + turnDownDuration;

        let progress = 0;
        if (leftTurnTime < turnUpDuration) {
          const t = leftTurnTime / turnUpDuration;
          progress = 1 - (1 - t) * (1 - t);
        } else if (leftTurnTime < totalDuration) {
          const t = (leftTurnTime - turnUpDuration) / turnDownDuration;
          progress = 1 - t * t;
        } else {
          resetLeftTurn();
          return;
        }

        if (boneParams.Pelvis && skierBones.Pelvis) {
          boneParams.Pelvis.y =
            leftTurnBaseValues.pelvisY +
            (leftTurnParams.pelvisY - leftTurnBaseValues.pelvisY) * progress;
          updateBoneRotation("Pelvis");
          updateBoneSlider("Pelvis", "Y");
        }

        if (boneParams.Head && skierBones.Head) {
          boneParams.Head.y =
            leftTurnBaseValues.headY +
            (leftTurnParams.headY - leftTurnBaseValues.headY) * progress;
          updateBoneRotation("Head");
          updateBoneSlider("Head", "Y");
        }
      }

      function startCrashAnimation() {
        if (!boneParams.L_Thigh || !boneParams.R_Thigh || !boneParams.Head)
          return;

        // Store base values (current position)
        if (boneParams.Pelvis) crashBaseValues.pelvisZ = boneParams.Pelvis.z;
        if (boneParams.Hip) {
          crashBaseValues.hipX = boneParams.Hip.x;
          crashBaseValues.hipY = boneParams.Hip.y;
          crashBaseValues.hipZ = boneParams.Hip.z;
        }
        crashBaseValues.lThighY = boneParams.L_Thigh.y;
        crashBaseValues.lThighZ = boneParams.L_Thigh.z;
        crashBaseValues.rThighY = boneParams.R_Thigh.y;
        crashBaseValues.rThighZ = boneParams.R_Thigh.z;
        crashBaseValues.headZ = boneParams.Head.z;
        if (boneParams.R_Hand) crashBaseValues.rHandY = boneParams.R_Hand.y;
        if (boneParams.L_Hand) crashBaseValues.lHandY = boneParams.L_Hand.y;

        isCrashing = true;
        crashTime = 0;
        document.getElementById("test-crash").textContent = "Animating...";
      }

      function resetCrashAnimation() {
        if (!boneParams.L_Thigh || !boneParams.R_Thigh || !boneParams.Head)
          return;

        // Reset to base values
        if (boneParams.Pelvis) {
          boneParams.Pelvis.z = crashBaseValues.pelvisZ;
          updateBoneRotation("Pelvis");
          updateBoneSlider("Pelvis", "Z");
        }
        if (boneParams.Hip) {
          boneParams.Hip.x = crashBaseValues.hipX;
          boneParams.Hip.y = crashBaseValues.hipY;
          boneParams.Hip.z = crashBaseValues.hipZ;
          updateBoneRotation("Hip");
          updateBoneSlider("Hip", "X");
          updateBoneSlider("Hip", "Y");
          updateBoneSlider("Hip", "Z");
        }
        boneParams.L_Thigh.y = crashBaseValues.lThighY;
        boneParams.L_Thigh.z = crashBaseValues.lThighZ;
        boneParams.R_Thigh.y = crashBaseValues.rThighY;
        boneParams.R_Thigh.z = crashBaseValues.rThighZ;
        boneParams.Head.z = crashBaseValues.headZ;
        if (boneParams.R_Hand) boneParams.R_Hand.y = crashBaseValues.rHandY;
        if (boneParams.L_Hand) boneParams.L_Hand.y = crashBaseValues.lHandY;

        updateBoneRotation("L_Thigh");
        updateBoneRotation("R_Thigh");
        updateBoneRotation("Head");
        if (boneParams.R_Hand) updateBoneRotation("R_Hand");
        if (boneParams.L_Hand) updateBoneRotation("L_Hand");

        updateBoneSlider("L_Thigh", "Y");
        updateBoneSlider("L_Thigh", "Z");
        updateBoneSlider("R_Thigh", "Y");
        updateBoneSlider("R_Thigh", "Z");
        updateBoneSlider("Head", "Z");
        if (boneParams.R_Hand) updateBoneSlider("R_Hand", "Y");
        if (boneParams.L_Hand) updateBoneSlider("L_Hand", "Y");

        isCrashing = false;
        crashTime = 0;
        document.getElementById("test-crash").textContent =
          "Test Crash Animation";
      }

      function updateCrashAnimation(deltaTime) {
        if (!isCrashing) return;

        crashTime += deltaTime * crashAnimationSpeed;
        const crashUpDuration = 0.3; // Time to go from base to crash position
        const crashDownDuration = 0.3; // Time to go from crash back to base
        const totalDuration = crashUpDuration + crashDownDuration;

        let progress = 0;
        if (crashTime < crashUpDuration) {
          const t = crashTime / crashUpDuration;
          progress = 1 - (1 - t) * (1 - t);
        } else if (crashTime < totalDuration) {
          const t = (crashTime - crashUpDuration) / crashDownDuration;
          progress = 1 - t * t;
        } else {
          resetCrashAnimation();
          return;
        }

        if (boneParams.Pelvis && skierBones.Pelvis) {
          boneParams.Pelvis.z =
            crashBaseValues.pelvisZ +
            (crashAnimationParams.pelvisZ - crashBaseValues.pelvisZ) * progress;
          updateBoneRotation("Pelvis");
          updateBoneSlider("Pelvis", "Z");
        }

        if (boneParams.Hip && skierBones.Hip) {
          boneParams.Hip.x =
            crashBaseValues.hipX +
            (crashAnimationParams.hipX - crashBaseValues.hipX) * progress;
          boneParams.Hip.y =
            crashBaseValues.hipY +
            (crashAnimationParams.hipY - crashBaseValues.hipY) * progress;
          boneParams.Hip.z =
            crashBaseValues.hipZ +
            (crashAnimationParams.hipZ - crashBaseValues.hipZ) * progress;
          updateBoneRotation("Hip");
          updateBoneSlider("Hip", "X");
          updateBoneSlider("Hip", "Y");
          updateBoneSlider("Hip", "Z");
        }

        if (boneParams.L_Thigh && skierBones.L_Thigh) {
          boneParams.L_Thigh.y =
            crashBaseValues.lThighY +
            (crashAnimationParams.lThighY - crashBaseValues.lThighY) * progress;
          boneParams.L_Thigh.z =
            crashBaseValues.lThighZ +
            (crashAnimationParams.lThighZ - crashBaseValues.lThighZ) * progress;
          updateBoneRotation("L_Thigh");
          updateBoneSlider("L_Thigh", "Y");
          updateBoneSlider("L_Thigh", "Z");
        }

        if (boneParams.R_Thigh && skierBones.R_Thigh) {
          boneParams.R_Thigh.y =
            crashBaseValues.rThighY +
            (crashAnimationParams.rThighY - crashBaseValues.rThighY) * progress;
          boneParams.R_Thigh.z =
            crashBaseValues.rThighZ +
            (crashAnimationParams.rThighZ - crashBaseValues.rThighZ) * progress;
          updateBoneRotation("R_Thigh");
          updateBoneSlider("R_Thigh", "Y");
          updateBoneSlider("R_Thigh", "Z");
        }

        if (boneParams.Head && skierBones.Head) {
          boneParams.Head.z =
            crashBaseValues.headZ +
            (crashAnimationParams.headZ - crashBaseValues.headZ) * progress;
          updateBoneRotation("Head");
          updateBoneSlider("Head", "Z");
        }

        if (boneParams.R_Hand && skierBones.R_Hand) {
          boneParams.R_Hand.y =
            crashBaseValues.rHandY +
            (crashAnimationParams.rHandY - crashBaseValues.rHandY) * progress;
          updateBoneRotation("R_Hand");
          updateBoneSlider("R_Hand", "Y");
        }

        if (boneParams.L_Hand && skierBones.L_Hand) {
          boneParams.L_Hand.y =
            crashBaseValues.lHandY +
            (crashAnimationParams.lHandY - crashBaseValues.lHandY) * progress;
          updateBoneRotation("L_Hand");
          updateBoneSlider("L_Hand", "Y");
        }
      }

      function animate() {
        requestAnimationFrame(animate);

        const deltaTime = 0.016; // ~60fps
        updateAnimations(deltaTime);
        updateJumpAnimation(deltaTime);
        updateRightTurnAnimation(deltaTime);
        updateLeftTurnAnimation(deltaTime);
        updateCrashAnimation(deltaTime);

        controls.update();
        renderer.render(scene, camera);
      }

      init();
    </script>
  </body>
</html>
